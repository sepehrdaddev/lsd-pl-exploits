#!/bin/sh
## copyright LAST STAGE OF DELIRIUM jul 2000 poland            *://lsd-pl.net/ #
## telnetd fix                                                                 #

echo "copyright LAST STAGE OF DELIRIUM jul 2000 poland  //lsd-pl.net/"
echo "telnetd bug fix for irix 6.2 6.3 6.4 6.5 6.5.8 IP:all\n"

PATH=.:/bin:$PATH
EXECUTABLE=/usr/etc/telnetd
FIX=fix

if [ -f "$EXECUTABLE.org" ]
    then
    echo "error: $EXECUTABLE.org binary existing."
    exit 1
fi
cp $EXECUTABLE $EXECUTABLE.org
chmod 0 $EXECUTABLE.org

cat > $FIX.c << 'EOF'
#include <sys/types.h>
#include <sys/stat.h> 
#include <fcntl.h>
#include <unistd.h>

char pattern1[]="ignored attempt to setenv(%.32s,%.128s)";
char pattern2[]="ignored attempt to setenv(_RLD - fixed)";

int main(int argc,char **argv){
    char buf[4096],*b;int i,fd,cnt;

    if((fd=open(argv[1],O_RDWR))==-1){perror("error");exit(-1);}
    while(1){ 
        if((cnt=read(fd,buf,4096))<sizeof(pattern1)) break;
        b=buf;
        while(b<((&buf[cnt])-sizeof(pattern1))){
            if(!memcmp(b,pattern1,sizeof(pattern1))) goto found;
            b+=4;
        } 
    }
    printf("error: pattern not found. not fixed!\n");
    close(fd);exit(-1);

found:
    printf("fixed!\n");
    memcpy(b,pattern2,sizeof(pattern2));
    lseek(fd,-(cnt),SEEK_CUR);
    write(fd,buf,cnt);
    close(fd);exit(0);
}
EOF
cc $FIX.c -o $FIX
if [ ! -f "$FIX" ]
    then
    echo "error: building binary"
    exit 1
fi
$FIX $EXECUTABLE
rm -rf $FIX.c $FIX 

echo "$EXECUTABLE.org: "`strings $EXECUTABLE.org | grep ignored`
echo "$EXECUTABLE:     "`strings $EXECUTABLE | grep ignored`

